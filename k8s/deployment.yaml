apiVersion: v1
kind: Service
metadata:
  namespace: zodiac
  name: orion-ui
  labels:
    app: orion-ui
spec:
  type: NodePort
  selector:
    app: orion-ui
  ports:
    - name: http
      port: 80
      targetPort: 80
      nodePort: 30081
---
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: zodiac
  name: orion-ui-nginx
data:
  default.conf: |
    server {
      listen 80;
      server_name _;

      root /usr/share/nginx/html;
      index index.html;
      resolver 10.96.0.10 valid=10s;

      location / {
        try_files $uri $uri/ /index.html;
      }

      location /api/ {
        rewrite ^/api/?(.*)$ /$1 break;
        proxy_pass http://mcp-client-service.zodiac.svc.cluster.local:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
      }

      location /agent-api/ {
        rewrite ^/agent-api/?(.*)$ /$1 break;
        proxy_pass http://agent-api.zodiac.svc.cluster.local:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: zodiac
  name: orion-ui
  labels:
    app: orion-ui
spec:
  replicas: 1
  selector:
    matchLabels:
      app: orion-ui
  template:
    metadata:
      labels:
        app: orion-ui
    spec:
      imagePullSecrets:
        - name: regcred
      containers:
        - name: orion-ui
          image: git.tu-berlin.de:5000/zodiac/zodiac-meta/orion-ui:latest
          imagePullPolicy: Always
          env:
          - name: VITE_CHAT_API_BASE
            value: "/api"
          - name: VITE_CHAT_API_PATH
            value: "/chat"
          - name: VITE_AGENT_API_BASE
            value: /agent-api
          ports:
            - containerPort: 80
          volumeMounts:
            - name: orion-ui-nginx
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: default.conf
      volumes:
        - name: orion-ui-nginx
          configMap:
            name: orion-ui-nginx
---
apiVersion: v1
kind: Service
metadata:
  namespace: zodiac
  name: agent-redis
  labels:
    app: agent-redis
spec:
  type: ClusterIP
  ports:
    - name: redis
      port: 6379
      targetPort: 6379
      protocol: TCP
  selector:
    app: agent-redis
---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: zodiac
  name: agent-redis
  labels:
    app: agent-redis
spec:
  replicas: 1
  selector:
    matchLabels:
      app: agent-redis
  template:
    metadata:
      labels:
        app: agent-redis
    spec:
      containers:
        - name: redis
          image: redis:7-alpine
          ports:
            - containerPort: 6379
          resources:
            {}

---
apiVersion: v1
kind: Service
metadata:
  namespace: zodiac
  name: agent-api
  labels:
    app: agent-api
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 3000
      targetPort: 3000
      protocol: TCP
  selector:
    app: agent-api
---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: zodiac
  name: agent-api
  labels:
    app: agent-api
spec:
  replicas: 1
  selector:
    matchLabels:
      app: agent-api
  template:
    metadata:
      labels:
        app: agent-api
    spec:
      imagePullSecrets:
        - name: regcred
      containers:
        - name: agent-api
          image: git.tu-berlin.de:5000/zodiac/zodiac-meta/agent:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 3000
          env:
            - name: REDIS_URL
              value: redis://agent-redis:6379
            - name: MCP_CLIENT_URL
              value: http://mcp-client-service:8000/chat
            - name: PORT
              value: "3000"
          resources:
            {}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: zodiac
  name: agent-worker
  labels:
    app: agent-worker
spec:
  replicas: 1
  selector:
    matchLabels:
      app: agent-worker
  template:
    metadata:
      labels:
        app: agent-worker
    spec:
      imagePullSecrets:
        - name: regcred
      containers:
        - name: agent-worker
          image: git.tu-berlin.de:5000/zodiac/zodiac-meta/agent:latest
          imagePullPolicy: Always
          command: ["npm", "run", "worker"]
          env:
            - name: REDIS_URL
              value: redis://agent-redis:6379
            - name: MCP_CLIENT_URL
              value: http://mcp-client-service:8000/chat
          resources:
            {}
